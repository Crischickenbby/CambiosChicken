{% extends 'base.html' %}

{% block title %} Ventas {% endblock %}

{% block contenido %}

<section class="inventario">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb breadcrumb-chevron p-3 bg-body-tertiary rounded-3">
      <li class="breadcrumb-item">
        <a class="link-body-emphasis fw-semibold text-decoration-none" href="#">Tablero</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        Ventas
      </li>
    </ol>
  </nav>

  <h1 class="inventario__titulo text-center">Ventas</h1>

  <button type="button" class="btn_agregar btn btn-primary my-2" id="add-product-btn">
    Agregar Producto
  </button>

  <!-- Botón para realizar la venta -->
  <button type="button" class="btn_venta btn btn-success my-2">
    Realizar Venta
  </button>

  <button type="button" class="btn_reset btn btn-danger my-2">
    Resetear Ventas
  </button>

  <div class="float-end">
    <div class="btn-group" role="group" aria-label="Forma de Pago">
      <input class="btn-check" type="radio" name="forma-pago" id="efectivo" autocomplete="off" value="efectivo">
      <label class="btn btn-outline-primary" for="efectivo">Efectivo</label>
  
      <input class="btn-check" type="radio" name="forma-pago" id="tarjeta" autocomplete="off" value="tarjeta">
      <label class="btn btn-outline-primary" for="tarjeta">Tarjeta</label>
    </div>
  </div>
  
  <div id="total-venta" class="text-end fw-bold mt-3">
    Total: $0.00
  </div>

  <div id="alert-container" class="mt-3"></div>

  <table class="table table-hover table-striped align-middle">
    <thead>
      <tr>
        <th scope="col">Productos</th>
        <th scope="col">Cantidad</th>
        <th scope="col">Monto</th>
        <th scope="col">Eliminar</th>
      </tr>
    </thead>
    <tbody id="ventas-table-body">
    </tbody>
  </table>

  <div class="modal fade" id="productsModal" tabindex="-1" aria-labelledby="productsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productsModalLabel">Seleccionar Producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul id="product-list" class="list-group">
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function(){
      // Función para cargar datos de ventas desde localStorage
      function cargarVentasDesdeLocalStorage() {
        let ventasGuardadas = localStorage.getItem('ventas');
        if (ventasGuardadas) {
          $('#ventas-table-body').html(ventasGuardadas);
          actualizarTotalVenta();
        }
      }
  
      // Función para guardar datos de ventas en localStorage
      function guardarVentasEnLocalStorage() {
        let ventasHTML = $('#ventas-table-body').html();
        localStorage.setItem('ventas', ventasHTML);
      }
  
      // Función para calcular y actualizar el total de la venta
      function actualizarTotalVenta() {
        let total = 0;
        $('#ventas-table-body tr').each(function() {
          let monto = parseFloat($(this).find('td:nth-child(3)').text());
          total += monto;
        });
        $('#total-venta').text('Total: $' + total.toFixed(2));
      }
  
      // Restaurar ventas desde localStorage al cargar la página
      cargarVentasDesdeLocalStorage();
  
      // Mostrar alerta
      function mostrarAlerta(mensaje, tipo) {
        const alertHtml = `<div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                             ${mensaje}
                             <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                           </div>`;
        $('#alert-container').html(alertHtml);
        // Desaparecer la alerta después de 5 segundos
        setTimeout(function() {
          $('.alert').alert('close');
        }, 5000);
      }
  
      // Mostrar alerta de producto agregado
      function mostrarAlertaProductoAgregado(productName) {
        mostrarAlerta(`Producto "${productName}" agregado`, 'success');
      }
  
      // Mostrar alerta de producto eliminado
      function mostrarAlertaProductoEliminado(productName) {
        mostrarAlerta(`Producto "${productName}" eliminado de la tabla de ventas`, 'info');
      }
  
      // Cargar productos cuando se hace clic en el botón "Agregar Producto"
      $('#add-product-btn').click(function(){
        $.get('/api/productos', function(data){
          let productList = $('#product-list');
          productList.empty();
          data.forEach(product => {
            productList.append(
              `<li class="list-group-item" data-id="${product.id}" data-nombre="${product.Nombre}" data-precio="${product.Precio_venta}">${product.Nombre} - ${product.Precio_venta}</li>`
            );
          });
          $('#productsModal').modal('show');
        });
      });
  
      // Agregar producto a la tabla cuando se selecciona
      $('#product-list').on('click', 'li', function(){
        let productName = $(this).data('nombre');
        let productPrice = $(this).data('precio');
        let productId = $(this).data('id');
        $('#ventas-table-body').append(
          `<tr data-id="${productId}">
            <td>${productName}</td>
            <td>1</td>
            <td>${productPrice}</td>
            <td>
              <button class="btn btn-danger btn-sm delete-btn">Eliminar</button>
            </td>
          </tr>`
        );
        $('#productsModal').modal('hide');
        actualizarTotalVenta();
        guardarVentasEnLocalStorage(); // Guardar ventas en localStorage
        mostrarAlertaProductoAgregado(productName); // Mostrar alerta de producto agregado
      });
  
      // Eliminar producto de la tabla cuando se hace clic en el botón "Eliminar"
      $('#ventas-table-body').on('click', '.delete-btn', function(){
        let productName = $(this).closest('tr').find('td:first').text();
        $(this).closest('tr').remove();
        actualizarTotalVenta();
        guardarVentasEnLocalStorage(); // Guardar ventas en localStorage
        mostrarAlertaProductoEliminado(productName); // Mostrar alerta de producto eliminado
      });
  
      // Manejar el clic en el botón "Realizar Venta"
      $('.btn_venta').click(function() {
        let productosVendidos = [];
        let formaPago = $('input[name="forma-pago"]:checked').val(); // Obtener la forma de pago seleccionada
  
        $('#ventas-table-body tr').each(function() {
          let idProducto = $(this).data('id');
          let cantidad = parseInt($(this).find('td:nth-child(2)').text());
          productosVendidos.push({ id: idProducto, cantidad: cantidad });
        });
  
        if (productosVendidos.length === 0) {
          mostrarAlerta('No hay productos en la venta', 'warning');
          return;
        }
  
        $.ajax({
          type: 'POST',
          url: '/realizar_venta',
          contentType: 'application/json',
          data: JSON.stringify({ productos: productosVendidos, forma_pago: formaPago }), // Incluir la forma de pago en los datos de la venta
          success: function(response) {
            if (response.success) {
              $('#ventas-table-body').empty();
              actualizarTotalVenta();
              mostrarAlerta('Venta realizada con éxito', 'success');
              localStorage.removeItem('ventas'); // Eliminar datos de ventas en localStorage después de la venta
            } else {
              mostrarAlerta('Error al realizar la venta: ' + response.message, 'danger');
            }
          },
          error: function() {
            mostrarAlerta('Error en la comunicación con el servidor (ES POSIBLE QUE HAYAS PEDIDO MAS PRODUCTOS DE LOS QUE HAY EN EXISTENCIA, CHECA TU INVENTARIO!!!)', 'danger');
          }
        });
      });
  
      // Resetear todo lo relacionado con la venta al hacer clic en el botón "Resetear Ventas"
      $('.btn_reset').click(function() {
        $('#ventas-table-body').empty(); // Limpiar tabla de ventas
        actualizarTotalVenta(); // Actualizar total de la venta
        localStorage.removeItem('ventas'); // Eliminar datos de ventas en localStorage
        mostrarAlerta('Venta reseteada', 'info');
      });
    });
  </script>
  
  
  
  
  

{% endblock %}