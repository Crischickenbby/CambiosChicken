{% extends 'base.html' %}

{% block title %} Ventas {% endblock %}

{% block contenido %}

<section class="inventario">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb breadcrumb-chevron p-3 bg-body-tertiary rounded-3">
      <li class="breadcrumb-item">
        <a class="link-body-emphasis fw-semibold text-decoration-none" href="#">Tablero</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        Ventas
      </li>
    </ol>
  </nav>

  <h1 class="inventario__titulo text-center">Ventas</h1>

  <button type="button" class="btn_agregar btn btn-primary my-2" id="add-product-btn">
    Agregar Producto
  </button>

  <!-- Botón para realizar la venta -->
  <button type="button" class="btn_venta btn btn-success my-2">
    Realizar Venta
  </button>

  <div id="total-venta" class="text-end fw-bold mt-3">
    Total: $0.00
  </div>

  <div id="alert-container" class="mt-3"></div>

  <table class="table table-hover table-striped align-middle">
    <thead>
      <tr>
        <th scope="col">Productos</th>
        <th scope="col">Cantidad</th>
        <th scope="col">Monto</th>
        <th scope="col">Eliminar</th>
      </tr>
    </thead>
    <tbody id="ventas-table-body">
    </tbody>
  </table>

  <div class="modal fade" id="productsModal" tabindex="-1" aria-labelledby="productsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productsModalLabel">Seleccionar Producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul id="product-list" class="list-group">
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function(){
      // Función para calcular y actualizar el total de la venta
      function actualizarTotalVenta() {
        let total = 0;
        $('#ventas-table-body tr').each(function() {
          let monto = parseFloat($(this).find('td:nth-child(3)').text());
          total += monto;
        });
        $('#total-venta').text('Total: $' + total.toFixed(2));
      }

      // Mostrar alerta
      function mostrarAlerta(mensaje, tipo) {
        const alertHtml = `<div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                             ${mensaje}
                             <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                           </div>`;
        $('#alert-container').html(alertHtml);
      }

      // Cargar productos cuando se hace clic en el botón "Agregar Producto"
      $('#add-product-btn').click(function(){
        $.get('/api/productos', function(data){
          let productList = $('#product-list');
          productList.empty();
          data.forEach(product => {
            productList.append(
              `<li class="list-group-item" data-id="${product.id}" data-nombre="${product.Nombre}" data-precio="${product.Precio_venta}">${product.Nombre} - ${product.Precio_venta}</li>`
            );
          });
          $('#productsModal').modal('show');
        });
      });

      // Agregar producto a la tabla cuando se selecciona
      $('#product-list').on('click', 'li', function(){
        let productName = $(this).data('nombre');
        let productPrice = $(this).data('precio');
        let productId = $(this).data('id');
        $('#ventas-table-body').append(
          `<tr data-id="${productId}">
            <td>${productName}</td>
            <td>1</td>
            <td>${productPrice}</td>
            <td>
              <button class="btn btn-danger btn-sm delete-btn">Eliminar</button>
            </td>
          </tr>`
        );
        $('#productsModal').modal('hide');
        actualizarTotalVenta();
      });

      // Eliminar producto de la tabla cuando se hace clic en el botón "Eliminar"
      $('#ventas-table-body').on('click', '.delete-btn', function(){
        $(this).closest('tr').remove();
        actualizarTotalVenta();
      });

      // Manejar el clic en el botón "Realizar Venta"
      $('.btn_venta').click(function() {
        let productosVendidos = [];
        $('#ventas-table-body tr').each(function() {
          let idProducto = $(this).data('id');
          let cantidad = parseInt($(this).find('td:nth-child(2)').text());
          productosVendidos.push({ id: idProducto, cantidad: cantidad });
        });

        if (productosVendidos.length === 0) {
          mostrarAlerta('No hay productos en la venta', 'warning');
          return;
        }

        $.ajax({
          type: 'POST',
          url: '/realizar_venta',
          contentType: 'application/json',
          data: JSON.stringify(productosVendidos),
          success: function(response) {
            if (response.success) {
              $('#ventas-table-body').empty();
              actualizarTotalVenta();
              mostrarAlerta('Venta realizada con éxito', 'success');
            } else {
              mostrarAlerta('Error al realizar la venta: ' + response.message, 'danger');
            }
          },
          error: function() {
            mostrarAlerta('Error en la comunicación con el servidor (ES POSIBLE QUE HAYAS PEDIDO MAS PRODUCTOS DE LOS QUE HAY EN EXISTENCIA, CHECA TU INVENTARIO!!!)', 'danger');
          }
        });
      });
    });
  </script>

{% endblock %}
